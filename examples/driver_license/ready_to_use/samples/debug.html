<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamsoft Driver License Scanner - Debug</title>
    <script src="../dist/ddls.bundle.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #results {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            min-height: 200px;
        }

        .debug-info {
            background-color: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .error {
            background-color: #ffeaea;
            border: 1px solid #ff6b6b;
            color: #d63031;
        }

        .success {
            background-color: #eafaf1;
            border: 1px solid #00b894;
            color: #00884d;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>Dynamsoft Driver License Scanner - Debug Mode</h1>

    <div class="debug-info">
        <strong>Debug Mode:</strong> Source maps enabled for debugging TypeScript code
    </div>

    <div>
        <button id="launchScanner">Launch Scanner</button>
        <button id="testSetup">Test Setup</button>
        <button id="clearResults">Clear Results</button>
    </div>

    <div id="results">
        <p>Click "Test Setup" to verify everything is working, or "Launch Scanner" to start scanning.</p>
    </div>

    <script>
        const resultContainer = document.querySelector("#results");
        const launchButton = document.querySelector("#launchScanner");
        const testButton = document.querySelector("#testSetup");
        const clearButton = document.querySelector("#clearResults");

        let driverLicenseScanner;

        // Test if the library is loaded correctly
        testButton.addEventListener("click", () => {
            try {
                console.log("Testing setup...");
                resultContainer.innerHTML = `
          <div class="debug-info">
            <strong>Library Status:</strong> ${typeof Dynamsoft !== 'undefined' ? 'Loaded ✓' : 'Not Loaded ✗'}<br>
            <strong>DriverLicenseScanner:</strong> ${typeof Dynamsoft?.DriverLicenseScanner !== 'undefined' ? 'Available ✓' : 'Not Available ✗'}<br>
            <strong>Timestamp:</strong> ${new Date().toLocaleTimeString()}
          </div>
        `;

                if (typeof Dynamsoft?.DriverLicenseScanner !== 'undefined') {
                    resultContainer.innerHTML += '<div class="debug-info success">✓ Setup is working correctly! You can now launch the scanner.</div>';
                    launchButton.disabled = false;
                } else {
                    resultContainer.innerHTML += '<div class="debug-info error">✗ Setup failed. Check console for errors.</div>';
                }
            } catch (error) {
                console.error("Setup test failed:", error);
                resultContainer.innerHTML = `<div class="debug-info error">Setup test failed: ${error.message}</div>`;
            }
        });

        // Initialize the scanner
        function initializeScanner() {
            console.log("Initializing Driver License Scanner...");

            driverLicenseScanner = new Dynamsoft.DriverLicenseScanner({
                license: "YOUR_LICENSE_KEY_HERE", // You can use the default trial license
                scannerViewConfig: {
                    uiPath: "../dist/ddls.ui.html",
                },
                templateFilePath: "../dist/ddls.template.json",
                workflowConfig: {
                    captureFrontImage: true,
                    captureBackImage: true,
                    readBarcode: true,
                },
            });

            return driverLicenseScanner;
        }

        // Launch scanner with debugging
        launchButton.addEventListener("click", async () => {
            try {
                launchButton.disabled = true;
                resultContainer.innerHTML = '<div class="debug-info">Initializing scanner...</div>';

                console.log("=== Starting Driver License Scanner Debug Session ===");
                console.log("You can now set breakpoints in your TypeScript code!");

                if (!driverLicenseScanner) {
                    initializeScanner();
                }

                resultContainer.innerHTML = '<div class="debug-info">Scanner launched. Check the scanner window...</div>';

                // This is where you can set breakpoints in DevTools to debug
                debugger; // This will trigger debugger if DevTools is open

                const result = await driverLicenseScanner.launch();
                console.log("=== Scan Result ===", result);

                resultContainer.innerHTML = ""; // Clear placeholder content

                // Display results
                if (result && typeof result === 'object') {
                    let hasImages = false;

                    Object.keys(result).forEach((key) => {
                        const side = result[key];
                        console.log(`Processing result for ${key}:`, side);

                        if (side?._imageData) {
                            const canvas = side._imageData.toCanvas();
                            canvas.style.maxWidth = "300px";
                            canvas.style.margin = "10px";
                            canvas.style.border = "1px solid #ccc";
                            resultContainer.appendChild(canvas);
                            hasImages = true;

                            // Add debug info
                            const debugInfo = document.createElement('div');
                            debugInfo.className = 'debug-info';
                            debugInfo.innerHTML = `<strong>${key}:</strong> Image captured successfully`;
                            resultContainer.appendChild(debugInfo);
                        }
                    });

                    if (!hasImages) {
                        resultContainer.innerHTML = '<div class="debug-info error">No images captured. Check console for details.</div>';
                    } else {
                        resultContainer.innerHTML += '<div class="debug-info success">✓ Scan completed successfully!</div>';
                    }

                    // Display license data if available
                    if (result.licenseData) {
                        const licenseDiv = document.createElement('div');
                        licenseDiv.className = 'debug-info';
                        licenseDiv.innerHTML = `<strong>License Data:</strong> ${JSON.stringify(result.licenseData, null, 2)}`;
                        resultContainer.appendChild(licenseDiv);
                    }
                } else {
                    resultContainer.innerHTML = '<div class="debug-info error">No valid result returned from scanner.</div>';
                }

            } catch (error) {
                console.error("Scanner launch failed:", error);
                resultContainer.innerHTML = `<div class="debug-info error">Scanner failed: ${error.message}</div>`;
            } finally {
                launchButton.disabled = false;
            }
        });

        // Clear results
        clearButton.addEventListener("click", () => {
            resultContainer.innerHTML = '<p>Results cleared. Ready for next scan.</p>';
            console.clear();
            console.log("Debug session cleared.");
        });

        // Auto-test setup on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testButton.click();
            }, 1000);
        });

        // Add some helpful console logs
        console.log("=== Debug Page Loaded ===");
        console.log("Available debugging features:");
        console.log("1. Source maps enabled - you can debug TypeScript directly");
        console.log("2. Console logging for all major operations");
        console.log("3. Error handling with detailed messages");
        console.log("4. Breakpoint support (debugger; statement in launch function)");
        console.log("===============================");
    </script>
</body>

</html>